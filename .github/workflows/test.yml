name: winget-pkgs test
on:
  push:
    branches:
      - main
    paths-ignore:
      - README.md
      - .gitignore
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  test-links:
    runs-on: windows-latest
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5.0.0

      - name: Set up python packages
        shell: pwsh
        run: |
          pip install requests pyyaml

      - name: Detect changed folder
        id: detect
        shell: pwsh
        run: |
          git fetch origin ${{ github.event.before }} --depth=1
          $changed = git diff --name-only ${{ github.event.before }} ${{ github.sha }} | Where-Object { $_ -like "manifests/*" }

          if (-not $changed) {
            Write-Host "No manifest changes detected"
            if ($env:GITHUB_EVENT_NAME -eq "workflow_dispatch") {
              $folder = "manifests"
            } else {
              $folder = ""
            }
          } else {
            # Extract the top-level changed folder under manifests/
            $folder = $changed | ForEach-Object { Split-Path $_ -Parent } | Sort-Object -Unique
            Write-Host "Folder changed under manifests: $folder"
          }
      
          echo "folder=$folder" >> $env:GITHUB_OUTPUT

      - name: Run python scripts
        if: steps.detect.outputs.folder != ''
        shell: pwsh
        run: |
          python3 .\Tools\TestLinks.py ${{ steps.detect.outputs.folder }}

  test-install:
    runs-on: windows-latest
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5.0.0

      - name: Set up python packages
        shell: pwsh
        run: |
          pip install requests pyyaml

      - name: Set up winget
        shell: pwsh
        run: |
          winget --info
          winget source remove msstore

      - name: Detect changed folder
        id: detect
        shell: pwsh
        run: |
          git fetch origin ${{ github.event.before }} --depth=1
          $changed = git diff --name-only ${{ github.event.before }} ${{ github.sha }} | Where-Object { $_ -like "manifests/*" }

          if (-not $changed) {
            Write-Host "No manifest changes detected"
            $folder = ""
          } else {
            # Extract the top-level changed folder under manifests/
            $folder = $changed | ForEach-Object { Split-Path $_ -Parent } | Sort-Object -Unique
            Write-Host "Folder changed under manifests: $folder"
          }
      
          echo "folder=$folder" >> $env:GITHUB_OUTPUT

      - name: Run python scripts
        if: steps.detect.outputs.folder != ''
        shell: pwsh
        run: |
          python3 .\Tools\TestInstall.py ${{ steps.detect.outputs.folder }}

