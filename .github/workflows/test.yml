name: winget-pkgs test
on:
  push:
    branches:
      - main
    paths-ignore:
      - README.md
      - .gitignore
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  test-links:
    runs-on: windows-latest
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5.0.0

      - name: Set up python packages
        shell: pwsh
        run: |
          pip install requests pyyaml

      - name: Detect changed folder
        id: detect
        shell: pwsh
        run: |
          git fetch origin ${{ github.event.before }} --depth=1
          $changed = git diff --name-only ${{ github.event.before }} ${{ github.sha }}
          $manifestsChanged = $changed | Where-Object { $_ -like "manifests/*" }
          $itselfChanged = $changed | Where-Object { $_ -like "*test.yml" }

          if (-not $manifestsChanged) {
            Write-Host "No manifest changes detected"
            if ($env:GITHUB_EVENT_NAME -eq "workflow_dispatch" -or $itselfChanged) {
              $folder = "manifests"
            } else {
              $folder = ""
            }
          } else {
            # Extract the top-level changed folder under manifests/
            $folder = $manifestsChanged | ForEach-Object { Split-Path $_ -Parent } | Sort-Object -Unique
            Write-Host "Folder changed under manifests: $folder"
          }
      
          echo "folder=$folder" >> $env:GITHUB_OUTPUT

      - name: Run python scripts
        if: steps.detect.outputs.folder != ''
        shell: pwsh
        run: |
          python3 .\Tools\TestLinks.py ${{ steps.detect.outputs.folder }}

  test-install:
    runs-on: windows-latest
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5.0.0

      - name: Set up python packages
        shell: pwsh
        run: |
          pip install requests pyyaml

      - name: Set up winget
        shell: pwsh
        run: |
          [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
          function Get-ReleaseTag {
            $releasesAPIResponse = Invoke-RestMethod 'https://api.github.com/repos/microsoft/winget-cli/releases?per_page=100'
            if (!$script:Prerelease) {
              $releasesAPIResponse = $releasesAPIResponse.Where({ !$_.prerelease })
            }
            if (![String]::IsNullOrWhiteSpace($script:WinGetVersion)) {
              $releasesAPIResponse = @($releasesAPIResponse.Where({ $_.tag_name -match $('^v?' + [regex]::escape($script:WinGetVersion)) }))
            }
            if ($releasesAPIResponse.Count -lt 1) {
              Write-Output 'No WinGet releases found matching criteria'
              exit 1
            }
            $releasesAPIResponse = $releasesAPIResponse | Sort-Object -Property published_at -Descending
            return $releasesAPIResponse[0].tag_name
          }
          
          Install-PackageProvider -Name NuGet -Force -Verbose
          Install-Module -Name Microsoft.WinGet.Client -Force -Repository PSGallery -Verbose -AllowClobber
          Repair-WinGetPackageManager -Version $(Get-ReleaseTag) -Verbose
          winget --info
          winget source remove msstore

      - name: Detect changed folder
        id: detect
        shell: pwsh
        run: |
          git fetch origin ${{ github.event.before }} --depth=1
          $changed = git diff --name-only ${{ github.event.before }} ${{ github.sha }}
          $manifestsChanged = $changed | Where-Object { $_ -like "manifests/*" }
          $itselfChanged = $changed | Where-Object { $_ -like "*test.yml" }

          if (-not $manifestsChanged) {
            Write-Host "No manifest changes detected"
            $folder = ""
          } else {
            # Extract the top-level changed folder under manifests/
            $folder = $manifestsChanged | ForEach-Object { Split-Path $_ -Parent } | Sort-Object -Unique
            Write-Host "Folder changed under manifests: $folder"
          }
      
          echo "folder=$folder" >> $env:GITHUB_OUTPUT

      - name: Run python scripts
        if: steps.detect.outputs.folder != ''
        shell: pwsh
        run: |
          python3 .\Tools\TestInstall.py ${{ steps.detect.outputs.folder }}

